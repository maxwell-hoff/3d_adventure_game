<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D Navigation + Stars (Three.js)</title>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <style>
    html, body { height: 100%; margin: 0; background: #000; overflow: hidden; }
    #overlay {
      position: fixed; inset: 0;
      display: grid; place-items: center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.92);
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.45), rgba(0,0,0,0.85));
      cursor: pointer;
      user-select: none;
    }
    #panel {
      width: min(560px, calc(100vw - 32px));
      border-radius: 16px;
      padding: 18px 18px 14px;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      backdrop-filter: blur(6px);
      line-height: 1.35;
    }
    #panel h1 { font-size: 18px; margin: 0 0 10px; }
    #panel .k { display: inline-block; padding: 2px 6px; border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.06);
      font-weight: 600;
    }
    #hint {
      position: fixed; left: 14px; bottom: 12px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.85);
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 10px 12px;
      max-width: 520px;
      backdrop-filter: blur(6px);
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="overlay">
    <div id="panel">
      <h1>3D Exploration Demo</h1>
      Click to start (locks mouse).<br/><br/>
      Move: <span class="k">W</span><span class="k">A</span><span class="k">S</span><span class="k">D</span>
      &nbsp;|&nbsp; Sprint: <span class="k">Shift</span>
      &nbsp;|&nbsp; Jump: <span class="k">Space</span><br/>
      Map: <span class="k">M</span> (does not show your location)<br/>
      Look: <span class="k">Mouse</span>
      &nbsp;|&nbsp; Release mouse: <span class="k">Esc</span><br/><br/>
      Goal: wander paths + trees, then look up at the star dome.
    </div>
  </div>
  <div id="hint">Tip: press <b>M</b> for the map (no “you are here”). Use landmarks + the sky to deduce your location.</div>

  <script type="module">
    import * as THREE from "three";
    import { PointerLockControls } from "three/addons/controls/PointerLockControls.js";
    import { createStarSystem } from "./src/stars.js";
    import { createRng } from "./src/rng.js";
    import { createWorld } from "./src/world.js";
    import { createMapOverlay } from "./src/map.js";

    // --- Scene setup ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x05070c, 30, 220);

    const camera = new THREE.PerspectiveCamera(70, innerWidth / innerHeight, 0.1, 2000);
    camera.position.set(0, 1.7, 6);

    const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    // --- Pointer lock controls (mouse look + forward direction) ---
    const controls = new PointerLockControls(camera, renderer.domElement);
    scene.add(controls.getObject());

    const overlay = document.getElementById("overlay");
    overlay.addEventListener("click", () => controls.lock());
    controls.addEventListener("lock", () => overlay.style.display = "none");
    controls.addEventListener("unlock", () => overlay.style.display = "grid");

    // --- Lights ---
    scene.add(new THREE.AmbientLight(0x9fb6ff, 0.25));

    const moonLight = new THREE.DirectionalLight(0xcfe2ff, 0.55);
    moonLight.position.set(40, 80, 10);
    scene.add(moonLight);

    const warmFill = new THREE.DirectionalLight(0xffd9a6, 0.15);
    warmFill.position.set(-30, 25, -40);
    scene.add(warmFill);

    // --- World (seeded so the 2D map always matches the 3D scene) ---
    const worldSeed = "world-seed-1";
    const rng = createRng(worldSeed);
    const world = createWorld({ scene, rng });

    // --- Map overlay (deliberately hides your current position) ---
    const map = createMapOverlay({
      world,
      toggleKey: "m",
      onOpen: () => {
        // Ensure you can actually read the map without pointer lock fighting you.
        if (controls.isLocked) controls.unlock();
      }
    });

    // --- Sky / stars (in separate module so you can extend with patterns later) ---
    const starSystem = createStarSystem({
      seed: "demo-seed-1",
      starCount: 3000,
      radius: 900,
      skyRadius: 950,
      starSize: 2.2
    });
    scene.add(starSystem.group);

    // --- Movement / simple physics ---
    const key = { w:false,a:false,s:false,d:false, shift:false, space:false };
    addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if (k==="w") key.w = true;
      if (k==="a") key.a = true;
      if (k==="s") key.s = true;
      if (k==="d") key.d = true;
      if (k==="shift") key.shift = true;
      if (k===" ") key.space = true;
    });
    addEventListener("keyup", (e) => {
      const k = e.key.toLowerCase();
      if (k==="w") key.w = false;
      if (k==="a") key.a = false;
      if (k==="s") key.s = false;
      if (k==="d") key.d = false;
      if (k==="shift") key.shift = false;
      if (k===" ") key.space = false;
    });

    let velocityY = 0;
    let onGround = true;

    const clock = new THREE.Clock();

    function animate() {
      const dt = Math.min(clock.getDelta(), 0.033);

      // slow rotation of sky (feels like sky drift)
      starSystem.update(dt);

      if (controls.isLocked) {
        const speed = key.shift ? 8.0 : 4.5;

        // movement in camera-facing space, but keep it on XZ plane
        const forward = new THREE.Vector3();
        camera.getWorldDirection(forward);
        forward.y = 0;
        forward.normalize();

        const right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0,1,0)).normalize();

        const move = new THREE.Vector3();
        if (key.w) move.add(forward);
        if (key.s) move.sub(forward);
        if (key.d) move.add(right);
        if (key.a) move.sub(right);

        if (move.lengthSq() > 0) {
          move.normalize().multiplyScalar(speed * dt);
          controls.getObject().position.add(move);
        }

        // keep player roughly within the world
        const p = controls.getObject().position;
        const b = world.bounds ?? 240;
        p.x = THREE.MathUtils.clamp(p.x, -b, b);
        p.z = THREE.MathUtils.clamp(p.z, -b, b);

        // jump + gravity
        if (key.space && onGround) {
          velocityY = 5.2;
          onGround = false;
        }
        velocityY -= 9.8 * dt;
        p.y += velocityY * dt;

        // ground collision
        if (p.y <= 1.7) {
          p.y = 1.7;
          velocityY = 0;
          onGround = true;
        }
      }

      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();

    // --- Resize ---
    addEventListener("resize", () => {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
      renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    });

  </script>
</body>
</html>
